name: Build Flet Android APK

on:
  workflow_dispatch:  # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v3
      
    - name: ðŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        pip install flet
        pip install buildozer
        
    - name: âš™ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù buildozer.spec
      run: |
        cat > buildozer.spec << EOF
        [app]
        # Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        title = Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©
        package.name = calculator
        package.domain = com.example
        
        # Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        version = 1.0.0
        
        # Ù…Ù„Ù Ø§Ù„Ù…ØµØ¯Ø±
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas,json,ttf
        
        # Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        requirements = python3,flet==0.22.0
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Android
        android.permissions = INTERNET
        android.api = 33
        android.minapi = 21
        android.sdk = 24
        android.ndk = 23b
        android.arch = armeabi-v7a
        
        # Ø§Ù„ØªÙˆØ¬Ù‡
        orientation = portrait
        
        # Ø§Ù„Ø³Ù…Ø©
        fullscreen = 0
        
        [buildozer]
        log_level = 2
        warn_on_root = 1
        EOF
        
    - name: ðŸ”¨ Ø¨Ù†Ø§Ø¡ APK
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          python3-pip \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev
        
        # ØªØ«Ø¨ÙŠØª Cython
        pip3 install cython==0.29.33
        
        # Ø§Ù„Ø¨Ù†Ø§Ø¡
        echo "ðŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ APK..."
        buildozer -v android debug
        
    - name: â¬†ï¸ Ø±ÙØ¹ APK
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: calculator-apk
        path: bin/*.apk
        
    - name: ðŸ“± Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      if: success()
      run: |
        echo "ðŸŽ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ðŸ“² Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Flet App:"
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/main.py"
        echo ""
        echo "ðŸ“¥ Ù„ØªØ­Ù…ÙŠÙ„ APK:"
        echo "1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'calculator-apk' ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Artifacts"
        echo "2. Ø­Ù…Ù„ Ø§Ù„Ù…Ù„Ù .apk"
        echo "3. Ø§Ù†Ù‚Ù„Ù‡ Ù„Ù‡Ø§ØªÙÙƒ ÙˆØ«Ø¨ØªÙ‡"
